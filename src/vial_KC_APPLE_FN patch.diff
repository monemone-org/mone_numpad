From bd1e1c9fa4b848ef92fd9fab6c5631c3f0589856 Mon Sep 17 00:00:00 2001
From: monehsieh <monehsieh@gmail.com>
Date: Sat, 19 Mar 2022 00:45:04 -0700
Subject: [PATCH] added vial support

---
 keyboards/monenumpad/config.h                 | 28 ++++--
 keyboards/monenumpad/keymaps/via/rules.mk     |  1 -
 .../monenumpad/keymaps/{via => vial}/keymap.c | 22 ++++-
 keyboards/monenumpad/keymaps/vial/rules.mk    |  8 ++
 keyboards/monenumpad/keymaps/vial/vial.json   | 99 +++++++++++++++++++
 keyboards/monenumpad/readme.md                | 20 +++-
 keyboards/monenumpad/rules.mk                 |  7 ++
 7 files changed, 168 insertions(+), 17 deletions(-)
 delete mode 100644 keyboards/monenumpad/keymaps/via/rules.mk
 rename keyboards/monenumpad/keymaps/{via => vial}/keymap.c (79%)
 create mode 100644 keyboards/monenumpad/keymaps/vial/rules.mk
 create mode 100644 keyboards/monenumpad/keymaps/vial/vial.json

diff --git a/keyboards/monenumpad/config.h b/keyboards/monenumpad/config.h
index 7534f5126f..0385c26bba 100644
--- a/keyboards/monenumpad/config.h
+++ b/keyboards/monenumpad/config.h
@@ -14,7 +14,7 @@
  */
 #define VENDOR_ID    0x6D68      // "mh" = monehsieh
 #define PRODUCT_ID   0x0001
-#define DEVICE_VER   0x0001
+#define DEVICE_VER   0x0002      // version 2: vial
 #define MANUFACTURER monehsieh
 #define PRODUCT      monenumpad
 
@@ -45,12 +45,6 @@
 #define ENCODERS_PAD_B { B2 }
 #define ENCODER_RESOLUTION 4
 
-
-#define BOOTMAGIC_LITE_ROW 4
-#define BOOTMAGIC_LITE_COLUMN 0
-
-
-
 /*
  * Split Keyboard specific options, make sure you have 'SPLIT_KEYBOARD = yes' in your rules.mk, and define SOFT_SERIAL_PIN.
  */
@@ -152,5 +146,21 @@
 #define NO_ACTION_FUNCTION
 
 /* Bootmagic Lite key configuration */
-//#define BOOTMAGIC_LITE_ROW 0
-//#define BOOTMAGIC_LITE_COLUMN 0
+#define BOOTMAGIC_LITE_ROW 4
+#define BOOTMAGIC_LITE_COLUMN 0
+
+
+#define VIAL_KEYBOARD_UID {0xE1, 0x03, 0xDC, 0xC8, 0xB3, 0x98, 0x04, 0x18}
+// top 2 keys of right most column
+#define VIAL_UNLOCK_COMBO_ROWS {0,1}
+#define VIAL_UNLOCK_COMBO_COLS {4,4}
+
+#define VIAL_ENCODER_DEFAULT { KC_VOLD, KC_VOLU, KC_BRID, KC_BRIU, KC_TRNS, KC_TRNS, KC_TRNS, KC_TRNS }
+
+
+
+
+
+
+
+
diff --git a/keyboards/monenumpad/keymaps/via/rules.mk b/keyboards/monenumpad/keymaps/via/rules.mk
deleted file mode 100644
index 1e5b99807c..0000000000
--- a/keyboards/monenumpad/keymaps/via/rules.mk
+++ /dev/null
@@ -1 +0,0 @@
-VIA_ENABLE = yes
diff --git a/keyboards/monenumpad/keymaps/via/keymap.c b/keyboards/monenumpad/keymaps/vial/keymap.c
similarity index 79%
rename from keyboards/monenumpad/keymaps/via/keymap.c
rename to keyboards/monenumpad/keymaps/vial/keymap.c
index 13bff92e00..a0cfb776d1 100644
--- a/keyboards/monenumpad/keymaps/via/keymap.c
+++ b/keyboards/monenumpad/keymaps/vial/keymap.c
@@ -6,7 +6,9 @@
 // Defines names for use in layer keycodes and the keymap
 enum layer_names {
     _BASE,
-    _FN
+    _FN1,
+    _FN2,
+    _FN3
 };
 
 /*
@@ -29,12 +31,28 @@ const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {
 KC_MUTE, KC_P1,  KC_P2,   KC_P3, 
 KC_BSPACE,    KC_P0   ,   KC_DOT,  KC_PENT),
 
-    [_FN] = LAYOUT(
+    [_FN1] = LAYOUT(
+          _______, _______, _______, _______, 
+          _______, _______, _______, _______, 
+          _______, _______, _______, _______, 
+ _______, _______, _______, _______,  
+ _______,     _______     , _______, _______),
+
+
+    [_FN2] = LAYOUT(
+          _______, _______, _______, _______, 
+          _______, _______, _______, _______, 
+          _______, _______, _______, _______, 
+ _______, _______, _______, _______,  
+ _______,     _______     , _______, _______),
+
+    [_FN3] = LAYOUT(
           _______, _______, _______, _______, 
           _______, _______, _______, _______, 
           _______, _______, _______, _______, 
  _______, _______, _______, _______,  
  _______,     _______     , _______, _______)
+
 };
 
 
diff --git a/keyboards/monenumpad/keymaps/vial/rules.mk b/keyboards/monenumpad/keymaps/vial/rules.mk
new file mode 100644
index 0000000000..83e6e1d80c
--- /dev/null
+++ b/keyboards/monenumpad/keymaps/vial/rules.mk
@@ -0,0 +1,8 @@
+VIA_ENABLE = yes
+VIAL_ENABLE = yes
+VIAL_ENCODERS_ENABLE = yes
+
+# LTO makes the compiler work harder when optimizing your code, resulting in a smaller firmware size
+#LTO_ENABLE = yes
+
+QMK_SETTINGS = no
diff --git a/keyboards/monenumpad/keymaps/vial/vial.json b/keyboards/monenumpad/keymaps/vial/vial.json
new file mode 100644
index 0000000000..44fc43560b
--- /dev/null
+++ b/keyboards/monenumpad/keymaps/vial/vial.json
@@ -0,0 +1,99 @@
+{
+    "name": "monenumpad",
+    "vendorId": "0x6D68",
+    "productId": "0x0001",
+    "lighting": "none",
+    "matrix": {
+        "rows": 5,
+        "cols": 5
+    },
+    "layouts": {
+        "keymap": [
+
+  [
+    {
+      "x": 1.75
+    },
+    "0,1",
+    "0,2",
+    "0,3",
+    {
+      "x": -0.5,
+      "a": 7,
+      "f": 4,
+      "w": 14,
+      "h": 5,
+      "d": true
+    },
+    "",
+    {
+      "x": -13.5,
+      "a": 4,
+      "f": 3
+    },
+    "0,4"
+  ],
+  [
+    {
+      "x": 1.75
+    },
+    "1,1",
+    "1,2",
+    "1,3",
+    "1,4"
+  ],
+  [
+    {
+      "x": 1.75
+    },
+    "2,1",
+    "2,2",
+    "2,3",
+    "2,4"
+  ],
+  [
+    "3,0",
+    {
+      "f": 2,
+      "w": 0.75,
+      "h": 0.75
+    },
+    "0,0\n\n\n\n\n\n\n\n\ne",
+    {
+      "f": 3
+    },
+    "3,1",
+    "3,2",
+    "3,3",
+    {
+      "h": 2
+    },
+    "4,4"
+  ],
+  [
+    {
+      "y": -0.25,
+      "x": 1,
+      "f": 2,
+      "w": 0.75,
+      "h": 0.75
+    },
+    "0,1\n\n\n\n\n\n\n\n\ne"
+  ],
+  [
+    {
+      "y": -0.75,
+      "f": 3
+    },
+    "4,0",
+    {
+      "x": 0.75,
+      "w": 2
+    },
+    "4,2",
+    "4,3"
+  ]
+
+        ]
+    }
+}
diff --git a/keyboards/monenumpad/readme.md b/keyboards/monenumpad/readme.md
index a4156801ef..84afe81a56 100644
--- a/keyboards/monenumpad/readme.md
+++ b/keyboards/monenumpad/readme.md
@@ -8,20 +8,30 @@
 * Hardware Supported: *The PCBs, controllers supported*
 * Hardware Availability: *Links to where you can find this hardware*
 
+Install qmk
+
+    git clone https://github.com/vial-kb/vial-qmk.git
+
 Make example for this keyboard (after setting up your build environment):
 
-    make monenumpad:default
+    make monenumpad:vial
 
 Flashing example for this keyboard:
 
-    make monenumpad:default:flash
+    make monenumpad:vial:flash
 
 See the [build environment setup](https://docs.qmk.fm/#/getting_started_build_tools) and the [make instructions](https://docs.qmk.fm/#/getting_started_make_guide) for more information. Brand new to QMK? Start with our [Complete Newbs Guide](https://docs.qmk.fm/#/newbs).
 
+
+See [VIAL Porting Build](https://get.vial.today/docs/)
+
+
 ## Bootloader
 
-Enter the bootloader in 3 ways:
+Enter the bootloader in one of the following ways:
 
-* **Bootmagic reset**: Hold down the key at (0,0) in the matrix (usually the top left key or Escape) and plug in the keyboard
 * **Physical reset button**: Briefly press the button on the back of the PCB - some may have pads you must short instead
-* **Keycode in layout**: Press the key mapped to `RESET` if it is available
+* **Ground reset pin**: Short GND and RESET pin on the micro controller
+
+
+
diff --git a/keyboards/monenumpad/rules.mk b/keyboards/monenumpad/rules.mk
index 3138e4cd11..1c7011c38e 100644
--- a/keyboards/monenumpad/rules.mk
+++ b/keyboards/monenumpad/rules.mk
@@ -18,3 +18,10 @@ RGBLIGHT_ENABLE = no        # Enable keyboard RGB underglow
 AUDIO_ENABLE = no           # Audio output
 
 ENCODER_ENABLE = yes
+
+
+VIA_ENABLE = yes
+VIAL_ENABLE = yes
+VIAL_ENCODERS_ENABLE = yes
+
+
-- 
2.31.0

From 92d6a8949050d28a0287b8d20fabc78c3fc22b6f Mon Sep 17 00:00:00 2001
From: monehsieh <monehsieh@gmail.com>
Date: Thu, 24 Mar 2022 09:32:16 -0700
Subject: [PATCH] 1. intercepted encoder_update_kb to mone_encoder_update to
 allow us to override the encoder's behaviour.

---
 quantum/encoder.c | 10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

diff --git a/quantum/encoder.c b/quantum/encoder.c
index c0c1be52d3..26f73cc6de 100644
--- a/quantum/encoder.c
+++ b/quantum/encoder.c
@@ -73,7 +73,15 @@ __attribute__((weak)) bool encoder_update_kb(uint8_t index, bool clockwise) {
 
 #ifdef VIAL_ENCODERS_ENABLE
 #include "vial.h"
-#define encoder_update_kb vial_encoder_update
+    #ifdef MONE_ENCODERS_ENABLE
+        #define encoder_update_kb mone_encoder_update
+
+        __attribute__((weak)) bool mone_encoder_update(uint8_t index, bool clockwise) {
+            return vial_encoder_update(index, clockwise);
+        }
+    #else
+        #define encoder_update_kb vial_encoder_update
+    #endif
 #endif
 
 void encoder_init(void) {
-- 
2.31.0

